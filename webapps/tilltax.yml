---
- name: TillTax
  hosts: localhost
  become: True
  tasks:
    - name: tilltax postgres data container
      docker_container:
        name: tilltax-db-data
        image: postgres:9.6
        state: started

    - name: tilltax postgres
      docker_container:
        env_file: /home/{{ username }}/ansible/tilltax.env
        image: postgres:9.6
        name: tilltax-db
        state: started
        volumes_from:
          - tilltax-db-data

    - name: tilltax api
      docker_container:
        env_file: /home/{{ username }}/ansible/tilltax.env
        image: aliencyborg/tilltax-api
        name: tilltax-api
        pull: true
        restart: yes
        state: started
        links:
          - "tilltax-db:db"
        env:
          LETSENCRYPT_EMAIL: "admin@aliencyb.org"
          LETSENCRYPT_HOST: "api.tilltax.com"
          VIRTUAL_HOST: "api.tilltax.com"

    - name: tilltax web client
      docker_container:
        expose: 80
        image: aliencyborg/tilltax-web
        name: tilltax-web
        pull: yes
        restart: yes
        state: started
        env:
          PORT: 80
          LETSENCRYPT_EMAIL: 'admin@aliencyb.org'
          LETSENCRYPT_HOST: 'tilltax.com,www.tilltax.com'
          VIRTUAL_HOST: 'tilltax.com,www.tilltax.com'

